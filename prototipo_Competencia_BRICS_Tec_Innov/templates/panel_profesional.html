<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Médico - Sistema de Gestión Médica</title>
    <!-- CDN de Tailwind CSS para estilos modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado para usar la fuente Inter de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Clase para destacar el día actual en el calendario */
        .today {
            @apply ring-2 ring-blue-500 bg-blue-100 font-bold;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Barra de Navegación Formal -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <!-- Título o Logo del Sistema -->
            <div class="text-2xl font-bold text-blue-900">
                <a href="#" class="flex items-center space-x-2">
                    <!-- Icono de un estetoscopio -->
                    <img src="{{ url_for('static', filename='img/logo.jpg') }}" alt="ARQA Logo" class="h-12 w-auto mb-4">

                    <span>Sistema Médico</span>
                </a>
            </div>
            
            <!-- Enlaces de Navegación del Médico -->
            <div class="flex items-center space-x-4">
                <a href="#" onclick="showView('inicio-view')" id="nav-inicio" class="text-blue-900 hover:text-blue-600 font-semibold transition-colors duration-300">Inicio</a>
                <a href="#" onclick="showView('turnos-view')" id="nav-turnos" class="text-blue-900 hover:text-blue-600 font-semibold transition-colors duration-300">Turnos</a>
                <a href="#" onclick="showView('pacientes-view')" id="nav-pacientes" class="text-blue-900 hover:text-blue-600 font-semibold transition-colors duration-300">Pacientes</a>
                <form action="{{ url_for('logout') }}" method="get">
                    <button type="submit" class="text-red-600 hover:text-red-800 font-semibold transition-colors duration-300">
                        Cerrar Sesión
                    </button>
                </form>
            </div>
        </nav>
    </header>

    <!-- Contenido Principal -->
    <main class="flex-grow container mx-auto px-6 py-8">
        
        <!-- Vista de Inicio (visible por defecto) -->
        <div id="inicio-view" class="bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Bienvenido, Dr. {{ nombre_medico }}</h1>
            <p class="text-gray-600 mb-8">
                Aquí tienes un resumen rápido de tu agenda y pacientes.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Tarjeta de Turnos de Hoy -->
                <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow-md">
                    <h2 class="text-xl font-bold text-blue-800 mb-2">Turnos de Hoy</h2>
                    <p class="text-gray-700 text-lg"><span class="font-bold">5</span> pacientes</p>
                </div>
                <!-- Tarjeta de Próximos Turnos -->
                <div class="bg-green-50 p-6 rounded-xl border border-green-200 shadow-md">
                    <h2 class="text-xl font-bold text-green-800 mb-2">Próximos 7 días</h2>
                    <p class="text-gray-700 text-lg"><span class="font-bold">12</span> turnos agendados</p>
                </div>
                <!-- Tarjeta de Total de Pacientes -->
                <div class="bg-purple-50 p-6 rounded-xl border border-purple-200 shadow-md">
                    <h2 class="text-xl font-bold text-purple-800 mb-2">Total de Pacientes</h2>
                    <p class="text-gray-700 text-lg"><span class="font-bold">50+</span> en tu lista</p>
                </div>
            </div>
        </div>

        <!-- Vista de Turnos -->
        <div id="turnos-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Calendario y Turnos</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Columna Izquierda: Calendario y lista de turnos -->
                <div class="md:col-span-1 bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Calendario de Turnos</h2>
                        <!-- Encabezado del calendario -->
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="prevMonth()" class="text-blue-600 hover:text-blue-800 transition-colors">&lt; Anterior</button>
                            <h3 id="month-year" class="text-lg font-bold text-gray-800"></h3>
                            <button onclick="nextMonth()" class="text-blue-600 hover:text-blue-800 transition-colors">Siguiente &gt;</button>
                        </div>
                        <!-- Días de la semana -->
                        <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600 mb-2">
                            <span>Dom</span><span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
                        </div>
                        <!-- Contenedor del calendario (días) -->
                        <div id="calendar-body" class="grid grid-cols-7 gap-1 text-center text-gray-800">
                            <!-- Los días se renderizarán aquí con JS -->
                        </div>
                    </div>
                    
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Turnos del Día Seleccionado</h2>
                        <div id="selected-day-appointments-list" class="space-y-3">
                            <p class="text-gray-500">Haz clic en un día del calendario para ver los turnos.</p>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Formulario para agendar turnos y registrar imprevistos -->
                <div class="md:col-span-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner">
                    <!-- Formulario para agendar un nuevo turno -->
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Agendar un Turno</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Selecciona un día en el calendario y usa este formulario para agendar un turno.
                    </p>
                    <form id="schedule-appointment-form" class="mb-8">
                        <div class="mb-4">
                            <label for="appointment-patient-name" class="block text-gray-700 font-bold mb-2">Nombre del Paciente</label>
                            <input type="text" id="appointment-patient-name" required placeholder="Ej: Juan Pérez"
                                class="w-full p-3 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label for="appointment-time" class="block text-gray-700 font-bold mb-2">Hora</label>
                            <input type="time" id="appointment-time" required
                                class="w-full p-3 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">
                            Agendar Turno
                        </button>
                    </form>

                    <!-- Formulario para registrar pacientes de imprevisto -->
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Registrar Paciente de Imprevisto</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Usa este formulario para agregar a un paciente que no tenía un turno agendado.
                    </p>
                    <form id="unscheduled-patient-form">
                        <div class="mb-4">
                            <label for="unscheduled-patient-name" class="block text-gray-700 font-bold mb-2">Nombre del Paciente</label>
                            <input type="text" id="unscheduled-patient-name" required placeholder="Ej: Dra. Ana Gómez"
                                class="w-full p-3 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">
                            Registrar Imprevisto
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Vista de Pacientes -->
        <div id="pacientes-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Lista de Pacientes</h1>
            <div class="mb-6">
                <input type="text" id="patient-search-input" placeholder="Filtrar por nombre o CI..."
                    class="w-full p-3 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="patients-list-container">
                
            </div>
        </div>

        <!-- Vista de Detalle del Paciente -->
        <div id="detalle-paciente-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
            <div class="flex items-center mb-6">
                <button onclick="showView('pacientes-view')" class="text-blue-600 hover:text-blue-800 transition-colors duration-300 mr-4">
                    <!-- Icono de flecha izquierda -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Volver a Pacientes
                </button>
                <h1 id="patient-details-name" class="text-3xl font-bold text-gray-800"></h1>
            </div>
            
            <div id="patient-info-container">
                <!-- La información detallada del paciente se generará con JavaScript -->
            </div>
        </div>
    </main>

    <!-- Pie de Página -->
    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p class="text-sm">&copy; 2025 ARQA. Todos los derechos reservados.</p>
    </footer>

    <!-- Script para funcionalidad interactiva y datos -->
    <script>
        /* =========================
        Estado global
        ========================= */
        let pacientesResumen = [];           // /api/pacientes
        const detalleCache = {};            // cache por id { [id]: pacienteDetalle }
        let scheduledAppointments = [
            { date: '2024-10-25', time: '09:00', patientName: 'Lic. María Solís', specialty: 'Nutricionista' },
            { date: '2024-10-15', time: '10:30', patientName: 'Dra. Ana Gómez', specialty: 'Dermatóloga' },
            { date: '2024-10-15', time: '16:00', patientName: 'Dr. Javier Pérez', specialty: 'Cardiólogo' }
        ];
        let currentMonth = new Date().getMonth();
        let currentYear  = new Date().getFullYear();
        let selectedDay  = null;

        /* =========================
        Navegación entre vistas
        ========================= */
        function showView(viewId) {
            const views = ['inicio-view', 'turnos-view', 'pacientes-view', 'detalle-paciente-view'];
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');

            if (viewId === 'turnos-view') renderCalendar();
            if (viewId === 'pacientes-view') renderPacientes(pacientesResumen);
        }

        /* =========================
        Lista principal de pacientes
        (DNI + enfermedad actual)
        ========================= */
        function renderPacientes(lista) {
            const container = document.getElementById("patients-list-container");
            container.innerHTML = "";

            if (!lista || lista.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center col-span-full">No se encontraron pacientes.</p>`;
                return;
            }

            lista.forEach(p => {
                const card = document.createElement("div");
                card.className = "bg-gray-100 p-4 rounded-lg shadow cursor-pointer hover:bg-gray-200 transition";
                card.onclick = () => showPatientDetails(p.id);
                card.innerHTML = `
                    <p><strong>C.I.:</strong> ${p.ci || "No registrado"}</p>
                    <p><strong>Enfermedad actual:</strong> ${p.enfermedad_actual || "No especificada"}</p>
                `;
                container.appendChild(card);
            });
        }

        /* =========================
        Cargar detalle de paciente
        ========================= */
        function showPatientDetails(patientId) {
            // Usa cache si ya lo tenemos
            if (detalleCache[patientId]) {
                renderDetalle(detalleCache[patientId]);
                return;
            }
            fetch(`/api/pacientes/${patientId}`)
                .then(r => r.json())
                .then(p => {
                    if (p.error) throw new Error(p.error);
                    detalleCache[patientId] = p; // guardo en cache
                    renderDetalle(p);
                })
                .catch(err => console.error("Error cargando detalle del paciente:", err));
        }

        /* Helpers para formatear listas (acepta strings u objetos) */
        function liFromItem(item, campos = []) {
            // Si es string, mostrar como está
            if (typeof item === 'string') return `<li>${item}</li>`;
            // Si es objeto, intentar armar "fecha: texto" o concatenar campos
            const fecha = item.fecha || item.date || "";
            const texto = item.texto || item.descripcion || item.sintoma || item.observaciones || item.resultados || item.diagnostico || "";
            if (fecha || texto) return `<li>${fecha ? `<strong>${fecha}:</strong> ` : ""}${texto}</li>`;
            // Fallback: concatenar campos pedidos (si existen)
            const joined = campos.map(c => item[c]).filter(Boolean).join(" - ");
            return `<li>${joined || "—"}</li>`;
        }
        function ulFromArray(arr, campos = []) {
            if (!Array.isArray(arr) || arr.length === 0) {
                return `<ul class="list-disc list-inside text-gray-500"><li>Sin datos</li></ul>`;
            }
            return `<ul class="list-disc list-inside space-y-2 text-gray-700">
                ${arr.map(it => liFromItem(it, campos)).join('')}
            </ul>`;
        }

        /* Render del detalle (usa claves nuevas del backend) */
        function renderDetalle(patient) {
            // Mapea claves esperadas
            const nombre      = patient.nombre || patient.name || "Sin nombre";
            const ci          = patient.ci || "No registrado";
            const tipoSangre  = patient.tipo_sangre || patient.bloodType || "Desconocido";

            // Secciones (acepta string[] u objeto[])
            const sintomas            = patient.sintomas || [];
            const diagnosticos        = patient.diagnosticos || [];
            const examenes_fisicos    = patient.examenes_fisicos || [];
            const analisis_laboratorio= patient.analisis_laboratorio || [];
            const tratamientos        = patient.tratamientos || [];
            const notas_adicionales   = patient.notas_adicionales || patient.historial || [];

            document.getElementById('patient-details-name').textContent = `Historial de ${nombre}`;

            const container = document.getElementById('patient-info-container');
            container.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Datos Principales</h2>
                    <div class="p-6 bg-gray-50 rounded-xl border border-gray-200 shadow-inner">
                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-8">
                            <div class="flex-1"><span class="font-bold text-gray-700">Nombre:</span> ${nombre}</div>
                            <div class="flex-1"><span class="font-bold text-gray-700">C.I.:</span> ${ci}</div>
                            <div class="flex-1"><span class="font-bold text-gray-700">Tipo de Sangre:</span> ${tipoSangre}</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Síntomas</h2>
                        ${ulFromArray(sintomas)}
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Diagnóstico</h2>
                        ${ulFromArray(diagnosticos)}
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Exámenes Físicos</h2>
                        ${ulFromArray(examenes_fisicos)}
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Análisis de Laboratorio</h2>
                        ${ulFromArray(analisis_laboratorio)}
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Seguimiento de Tratamientos</h2>
                        ${ulFromArray(tratamientos)}
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Notas Adicionales</h2>
                        ${ulFromArray(notas_adicionales)}
                    </div>

                    <!-- Form para añadir nueva entrada (actualiza cache local) -->
                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow-md flex flex-col justify-between col-span-1 lg:col-span-2">
                        <h2 class="text-xl font-semibold text-blue-800 mb-4">Añadir Nueva Entrada al Historial</h2>
                        <form onsubmit="event.preventDefault(); addNewEntry(${patient.id || patient.ID});">
                            <div class="mb-4">
                                <label for="entry-type" class="block text-gray-700 font-bold mb-2">Tipo de Entrada</label>
                                <select id="entry-type" class="w-full p-3 text-gray-700 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="sintomas">Síntoma</option>
                                    <option value="diagnosticos">Diagnóstico</option>
                                    <option value="examenes_fisicos">Examen Físico</option>
                                    <option value="analisis_laboratorio">Análisis de Laboratorio</option>
                                    <option value="tratamientos">Tratamiento</option>
                                    <option value="notas_adicionales">Nota Adicional</option>
                                </select>
                            </div>
                            <textarea id="new-entry-textarea" class="w-full p-2 text-gray-700 border border-blue-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Escribe aquí la nueva entrada..."></textarea>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">
                                Guardar Entrada
                            </button>
                        </form>
                    </div>
                </div>
            `;

            showView('detalle-paciente-view');
        }

        /* =========================
        Añadir nueva entrada (cache local)
        (Si querés persistir, acá puedes hacer un fetch POST al backend)
        ========================= */
        function addNewEntry(patientId) {
            const textarea = document.getElementById('new-entry-textarea');
            const tipo = document.getElementById('entry-type').value;
            const texto = (textarea.value || "").trim();
            if (!texto) return;

            const hoy = new Date().toLocaleDateString('es-ES');
            const p = detalleCache[patientId];
            if (!p) return;

            // Asegurar array destino
            p[tipo] = Array.isArray(p[tipo]) ? p[tipo] : [];

            // Estructura genérica { fecha, texto }
            const entrada = { fecha: hoy, texto };

            // Para lab, ejemplo de campos extra
            if (tipo === 'analisis_laboratorio' && p[tipo].length === 0) {
                // si tuvieras estructura {fecha, estudio, resultados}
                // entrada.estudio = 'N/A';
                // entrada.resultados = texto;
            }

            p[tipo].push(entrada);
            textarea.value = '';
            renderDetalle(p); // re-render
        }

        /* =========================
        Calendario (sin cambios)
        ========================= */
        function renderCalendar() {
            const monthYear = document.getElementById('month-year');
            const calendarBody = document.getElementById('calendar-body');
            const today = new Date();
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay  = new Date(currentYear, currentMonth + 1, 0);

            monthYear.textContent = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(firstDay);
            calendarBody.innerHTML = '';

            for (let i = 0; i < firstDay.getDay(); i++) {
                calendarBody.innerHTML += `<div class="p-2 rounded-lg text-gray-400"></div>`;
            }
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = `p-2 rounded-lg cursor-pointer hover:bg-blue-200 transition-colors duration-200 relative`;
                dayDiv.textContent = i;

                const dayStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

                if (today.getDate() === i && today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                    dayDiv.classList.add('today');
                }

                const hasAppointments = scheduledAppointments.some(appt => appt.date === dayStr);
                if (hasAppointments) {
                    const dot = document.createElement('div');
                    dot.className = 'absolute bottom-1 right-1 h-2 w-2 rounded-full bg-blue-500';
                    dayDiv.appendChild(dot);
                }

                dayDiv.onclick = () => selectDay(dayStr);
                calendarBody.appendChild(dayDiv);
            }
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
            document.getElementById('selected-day-appointments-list').innerHTML = `<p class="text-gray-500">Selecciona un día para ver los turnos.</p>`;
        }
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
            document.getElementById('selected-day-appointments-list').innerHTML = `<p class="text-gray-500">Selecciona un día para ver los turnos.</p>`;
        }
        function selectDay(date) {
            selectedDay = date;
            const appointmentsForDay = scheduledAppointments.filter(appt => appt.date === date);
            const listContainer = document.getElementById('selected-day-appointments-list');
            listContainer.innerHTML = '';

            if (appointmentsForDay.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-500">No hay turnos para este día.</p>`;
                return;
            }
            appointmentsForDay.forEach(appt => {
                const item = document.createElement('div');
                item.className = 'bg-white border border-gray-200 rounded-lg p-3 shadow hover:shadow-md transition-shadow';
                item.innerHTML = `
                    <p class="font-bold text-blue-800">${appt.time} - ${appt.patientName}</p>
                    <p class="text-gray-600 text-sm">${appt.specialty}</p>
                `;
                listContainer.appendChild(item);
            });
        }

        /* =========================
        Búsqueda en lista principal
        ========================= */
        function attachSearch() {
            const input = document.getElementById('patient-search-input');
            if (!input) return;
            input.addEventListener('input', function() {
                const q = this.value.toLowerCase();
                const filtered = pacientesResumen.filter(p =>
                    (p.nombre || "").toLowerCase().includes(q) ||
                    (p.ci || "").toLowerCase().includes(q)
                );
                renderPacientes(filtered);
            });
        }

        /* =========================
        Inicio
        ========================= */
        document.addEventListener("DOMContentLoaded", () => {
            // Carga resumen (se recomienda que el backend incluya también "nombre" en cada item)
            fetch("/api/pacientes")
                .then(r => r.json())
                .then(data => {
                    pacientesResumen = Array.isArray(data) ? data : [];
                    renderPacientes(pacientesResumen);
                    attachSearch();
                })
                .catch(err => console.error("Error cargando pacientes:", err));

            showView('inicio-view');
        });

    </script>
</body>
</html>